name: Update AUR Package
run-name: Update AUR (${{ github.event_name == 'workflow_run' && 'New Release' || 'Manual Fix' }})

on:
  push:
    branches: [main]

  workflow_dispatch:

concurrency:
  group: update-aur
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  aur-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version and Repo Metadata
        id: get_version
        run: |
          repo_name=$(echo "${GITHUB_REPOSITORY#*/}" | tr '[:upper:]' '[:lower:]')
          echo "REPO_NAME=$repo_name" >> "$GITHUB_ENV"

            # Using sed to ensure we get a clean value without quotes
            PKGVER=$(sed -n 's/^pkgver=//p' PKGBUILD | tr -d '"' | tr -d "'")
            PKGREL=$(sed -n 's/^pkgrel=//p' PKGBUILD | tr -d '"' | tr -d "'")

            echo "VERSION=$PKGVER" >> "$GITHUB_ENV"
            echo "PKGREL=$PKGREL" >> "$GITHUB_ENV"

      - name: Validate Version Format
        run: |
          if [[ ! "${{ env.VERSION }}" =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
            echo "ERROR: Invalid version format detected: '${{ env.VERSION }}'"
            echo "Version must be numeric (e.g., 1.2.3). Stopping workflow."
            exit 1
          fi

      - name: Check Current AUR Version
        id: check_aur
        run: |
          AUR_FULL_VERSION=$(curl -s "https://aur.archlinux.org/rpc/v5/info/${{ env.REPO_NAME }}" | \
            jq -r '.results[0].Version // empty')

          REPO_FULL_VERSION="${{ env.VERSION }}-${{ env.PKGREL }}"

          echo "Repo version target: $REPO_FULL_VERSION"
          echo "AUR version current: $AUR_FULL_VERSION"

          if [ -z "$AUR_FULL_VERSION" ] || [ "$AUR_FULL_VERSION" == "null" ]; then
            echo "Package not in AUR yet. Proceeding."
            echo "SKIP_UPDATE=false" >> "$GITHUB_ENV"
          elif [ "$AUR_FULL_VERSION" == "$REPO_FULL_VERSION" ]; then
            echo "AUR is already up to date. Skipping."
            echo "SKIP_UPDATE=true" >> "$GITHUB_ENV"
          else
            # Verify if local is actually newer to prevent accidental downgrades
            if echo -e "${AUR_FULL_VERSION}\n${REPO_FULL_VERSION}" | sort -V -C 2>/dev/null; then
              echo "AUR version is older. Proceeding with update."
              echo "SKIP_UPDATE=false" >> "$GITHUB_ENV"
            else
              echo "Warning: AUR version is newer than Local. Skipping to prevent downgrade."
              echo "SKIP_UPDATE=true" >> "$GITHUB_ENV"
            fi
          fi

      - name: Update PKGBUILD and Checksums
        if: env.SKIP_UPDATE == 'false'
        run: |
          docker run --rm \
            -v "$PWD:/src" \
            -w /src \
            -e VERSION="${{ env.VERSION }}" \
            archlinux:base-devel sh -c '
              pacman -Sy --noconfirm pacman-contrib git

              # Generate new checksums and .SRCINFO
              updpkgsums
              makepkg --printsrcinfo > .SRCINFO

              # Fix permissions for the GitHub runner user (UID 1001)
              chown -R 1001:121 .
            '

      - name: Publish to AUR
        if: env.SKIP_UPDATE == 'false'
        uses: KSXGitHub/github-actions-deploy-aur@v2.2.5
        with:
          pkgname: ${{ env.REPO_NAME }}
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ env.VERSION }}-${{ env.PKGREL }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Trigger MyRepo Build
        if: success()
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: mydehq/my-repo
          event-type: trigger-build
